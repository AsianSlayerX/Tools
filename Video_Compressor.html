<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Video Compressor</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Georgia, serif;
            background: linear-gradient(135deg, #8b6f47 0%, #5d4e37 100%);
            min-height: 100vh;
            padding: 40px 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }
        
        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }
        
        input[type="file"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: Georgia, serif;
            background: white;
            transition: border-color 0.3s;
        }
        
        input[type="file"]:focus,
        select:focus {
            border-color: #7a5c3f;
            outline: none;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background: white;
            color: #7a5c3f;
            border: 2px solid #7a5c3f;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            font-family: Georgia, serif;
            transition: all 0.3s;
        }
        
        button:disabled {
            background: white;
            color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
        }
        
        button:hover:not(:disabled) {
            background: #7a5c3f;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(122, 92, 63, 0.3);
        }
        
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 40px;
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #7a5c3f;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-left: 4px solid #7a5c3f;
            border-radius: 6px;
            display: none;
        }
        
        .result h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .result p {
            color: #666;
            margin: 5px 0;
            font-size: 14px;
        }
        
        .download-btn {
            background: white;
            color: #4a7ba7;
            border-color: #4a7ba7;
            margin-top: 15px;
            width: 100%;
        }
        
        .download-btn:hover {
            background: #4a7ba7;
            color: white;
            box-shadow: 0 4px 8px rgba(74, 123, 167, 0.3);
        }
        
        .info {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
        }
        
        .info h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .info li {
            margin: 5px 0;
        }
        
        .file-info {
            margin-top: 10px;
            font-size: 13px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 20px 15px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Video Compressor</h1>
        <p class="subtitle">Reduce video file size by lowering resolution and quality</p>
        
        <div class="form-group">
            <label for="videoFile">Select Video File</label>
            <input type="file" id="videoFile" accept="video/mp4,video/quicktime,video/webm">
            <div class="file-info" id="fileInfo"></div>
        </div>
        
        <div class="form-group">
            <label for="resolution">Target Resolution</label>
            <select id="resolution">
                <option value="480">480p (854×480)</option>
                <option value="720" selected>720p (1280×720)</option>
                <option value="1080">1080p (1920×1080)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="quality">Compression Quality</label>
            <select id="quality">
                <option value="1000000">Low (1 Mbps) - Smallest file</option>
                <option value="2500000" selected>Medium (2.5 Mbps) - Balanced</option>
                <option value="5000000">High (5 Mbps) - Better quality</option>
            </select>
        </div>
        
        <button id="compressBtn" onclick="compressVideo()">Compress Video</button>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>
        
        <div class="result" id="result">
            <h3>✓ Compression Complete!</h3>
            <p><strong>Original size:</strong> <span id="originalSize"></span></p>
            <p><strong>Compressed size:</strong> <span id="compressedSize"></span></p>
            <p><strong>Size reduction:</strong> <span id="reduction"></span></p>
            <p><strong>Output format:</strong> <span id="outputFormat"></span></p>
            <p><strong>Browser:</strong> <span id="browserInfo"></span></p>
            <p id="shareSupport" style="font-size: 13px; color: #666; margin-top: 5px;"></p>
            
            <video id="resultVideo" controls style="width: 100%; margin: 15px 0; border-radius: 6px; display: none;"></video>
            
            <button class="download-btn" onclick="downloadVideo()">Download (Desktop)</button>
            <button class="download-btn" onclick="openInNewTab()" style="margin-top: 10px;">Save to Files (Mobile/iOS)</button>
        </div>
        
        <div class="info">
            <h4>How to Save on Mobile/iOS:</h4>
            <ul>
                <li><strong>Step 1:</strong> After compression completes, click "Save to Files (Mobile/iOS)"</li>
                <li><strong>Step 2:</strong> A share menu will appear - choose "Save to Files" or "Save Video"</li>
                <li><strong>Alternative:</strong> If share menu doesn't appear, video will open in new tab - long-press it and select "Save Video"</li>
            </ul>
            <h4 style="margin-top: 15px;">Technical Notes:</h4>
            <ul>
                <li><strong>Output format:</strong> MP4 only</li>
                <li><strong>Required browser:</strong> Safari (iOS/macOS) - other browsers don't support MP4 encoding</li>
                <li><strong>Accepts:</strong> MP4 and MOV video files as input</li>
                <li>Processing happens in your browser - no upload needed</li>
                <li>Large videos may take a few minutes to process</li>
            </ul>
        </div>
    </div>
    
    <video id="sourceVideo" style="display: none;"></video>
    <canvas id="canvas" style="display: none;"></canvas>
    
    <script>
        let inputFile = null;
        let outputBlob = null;
        let inputSize = 0;
        let fileExtension = 'mp4';
        
        const resolutionMap = {
            '480': { width: 854, height: 480 },
            '720': { width: 1280, height: 720 },
            '1080': { width: 1920, height: 1080 }
        };
        
        document.getElementById('videoFile').addEventListener('change', function(e) {
            inputFile = e.target.files[0];
            if (inputFile) {
                inputSize = inputFile.size;
                document.getElementById('fileInfo').textContent = 
                    'File: ' + inputFile.name + ' (' + formatFileSize(inputSize) + ')';
                document.getElementById('compressBtn').disabled = false;
                document.getElementById('result').style.display = 'none';
            }
        });
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }
        
        function detectBestFormat() {
            var mp4Types = [
                'video/mp4',
                'video/mp4;codecs=avc1',
                'video/mp4;codecs=h264'
            ];
            
            for (var i = 0; i < mp4Types.length; i++) {
                if (MediaRecorder.isTypeSupported(mp4Types[i])) {
                    fileExtension = 'mp4';
                    return mp4Types[i];
                }
            }
            
            // MP4 not supported - return null
            return null;
        }
        
        function compressVideo() {
            if (!inputFile) {
                alert('Please select a video file first');
                return;
            }
            
            // Check MP4 support first
            var mimeType = detectBestFormat();
            if (!mimeType) {
                showStatus('MP4 encoding is not supported in this browser. Please use Safari (iOS/macOS) for MP4 output.', 'error');
                return;
            }
            
            document.getElementById('compressBtn').disabled = true;
            document.getElementById('compressBtn').textContent = 'Compressing...';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('result').style.display = 'none';
            
            try {
                var video = document.getElementById('sourceVideo');
                var canvas = document.getElementById('canvas');
                var ctx = canvas.getContext('2d');
                
                video.src = URL.createObjectURL(inputFile);
                
                video.onloadedmetadata = function() {
                    var targetRes = resolutionMap[document.getElementById('resolution').value];
                    var videoAspect = video.videoWidth / video.videoHeight;
                    
                    canvas.width = targetRes.width;
                    canvas.height = Math.round(targetRes.width / videoAspect);
                    
                    var stream = canvas.captureStream(30);
                    var bitrate = parseInt(document.getElementById('quality').value);
                    
                    console.log('Using format:', mimeType);
                    
                    var mediaRecorder = new MediaRecorder(stream, {
                        mimeType: mimeType,
                        videoBitsPerSecond: bitrate
                    });
                    
                    var chunks = [];
                    
                    mediaRecorder.ondataavailable = function(e) {
                        if (e.data.size > 0) {
                            chunks.push(e.data);
                        }
                    };
                    
                    mediaRecorder.onstop = function() {
                        outputBlob = new Blob(chunks, { type: 'video/mp4' });
                        showResult();
                    };
                    
                    mediaRecorder.start();
                    video.play();
                    
                    var duration = video.duration;
                    
                    function drawFrame() {
                        if (video.paused || video.ended) {
                            mediaRecorder.stop();
                            return;
                        }
                        
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        var progress = Math.round((video.currentTime / duration) * 100);
                        var progressFill = document.getElementById('progressFill');
                        progressFill.style.width = progress + '%';
                        progressFill.textContent = progress + '%';
                        
                        requestAnimationFrame(drawFrame);
                    }
                    
                    drawFrame();
                };
                
                video.onerror = function() {
                    alert('Error loading video file');
                    resetUI();
                };
                
            } catch (error) {
                console.error('Compression error:', error);
                alert('Error compressing video: ' + error.message);
                resetUI();
            }
        }
        
        function showResult() {
            document.getElementById('compressBtn').disabled = false;
            document.getElementById('compressBtn').textContent = 'Compress Video';
            document.getElementById('progressContainer').style.display = 'none';
            
            var result = document.getElementById('result');
            result.style.display = 'block';
            
            document.getElementById('originalSize').textContent = formatFileSize(inputSize);
            document.getElementById('compressedSize').textContent = formatFileSize(outputBlob.size);
            
            var reduction = ((1 - outputBlob.size / inputSize) * 100).toFixed(1);
            document.getElementById('reduction').textContent = reduction + '%';
            document.getElementById('outputFormat').textContent = 'MP4';
            
            // Browser info
            var browser = 'Unknown';
            var ua = navigator.userAgent;
            if (ua.indexOf('Safari') > -1 && ua.indexOf('Chrome') === -1) browser = 'Safari';
            else if (ua.indexOf('Chrome') > -1) browser = 'Chrome';
            else if (ua.indexOf('Firefox') > -1) browser = 'Firefox';
            document.getElementById('browserInfo').textContent = browser + ' (iOS: ' + (/iPad|iPhone|iPod/.test(ua) ? 'Yes' : 'No') + ')';
            
            // Share support info
            var shareSupported = navigator.share && navigator.canShare ? 'Yes' : 'No';
            document.getElementById('shareSupport').textContent = 'Share API supported: ' + shareSupported;
            
            // Show video preview
            var resultVideo = document.getElementById('resultVideo');
            resultVideo.src = URL.createObjectURL(outputBlob);
            resultVideo.style.display = 'block';
        }
        
        function openInNewTab() {
            if (!outputBlob) return;
            
            // Try native share API first (works great on iOS)
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [outputBlob] })) {
                var originalName = inputFile.name.replace(/\.[^/.]+$/, '');
                var fileName = 'compressed_' + originalName + '.' + fileExtension;
                var file = new File([outputBlob], fileName, { type: outputBlob.type });
                
                navigator.share({
                    files: [file],
                    title: 'Compressed Video',
                    text: 'Compressed video file'
                }).then(function() {
                    showStatus('Video shared successfully! Choose where to save it.', 'success');
                }).catch(function(err) {
                    console.error('Share failed:', err);
                    fallbackOpen();
                });
            } else {
                fallbackOpen();
            }
        }
        
        function fallbackOpen() {
            var url = URL.createObjectURL(outputBlob);
            var newWindow = window.open(url, '_blank');
            
            if (newWindow) {
                showStatus('Video opened in new tab. Long-press the video to save it to your device.', 'info');
            } else {
                showStatus('Please allow pop-ups for this site to open the video.', 'error');
            }
        }
        
        function downloadVideo() {
            if (!outputBlob) return;
            
            // Mobile-friendly download approach
            var url = URL.createObjectURL(outputBlob);
            var originalName = inputFile.name.replace(/\.[^/.]+$/, '');
            var fileName = 'compressed_' + originalName + '.' + fileExtension;
            
            // Try standard download first
            var a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            
            // For mobile browsers that don't support download attribute
            if (!a.download) {
                // Open in new window so user can save manually
                window.open(url, '_blank');
                showStatus('Video opened in new window. Use your browser\'s save feature to download.', 'info');
            } else {
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
            
            // Don't revoke URL immediately on mobile
            setTimeout(function() {
                URL.revokeObjectURL(url);
            }, 5000);
        }
        
        function resetUI() {
            document.getElementById('compressBtn').disabled = false;
            document.getElementById('compressBtn').textContent = 'Compress Video';
            document.getElementById('progressContainer').style.display = 'none';
        }
        
        document.getElementById('compressBtn').disabled = true;
        
        // Check browser compatibility on load
        window.addEventListener('load', function() {
            var ua = navigator.userAgent;
            var isSafari = ua.indexOf('Safari') > -1 && ua.indexOf('Chrome') === -1;
            
            if (!isSafari) {
                var mimeType = detectBestFormat();
                if (!mimeType) {
                    showStatus('⚠️ This browser does not support MP4 encoding. Please use Safari (iOS/macOS) for this tool.', 'error');
                }
            }
        });
    </script>
</body>
</html>
