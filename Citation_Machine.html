<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citation Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 700px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
            text-align: center;
        }
        
        .format-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .format-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .format-btn.active {
            background: #667eea;
            color: white;
        }
        
        .format-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: 'Georgia', serif;
        }
        
        select {
            cursor: pointer;
            background: white;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .author-section {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafafa;
        }
        
        .author-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .author-number {
            font-weight: bold;
            color: #667eea;
        }
        
        .remove-author-btn {
            padding: 6px 12px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .remove-author-btn:hover {
            background: #ee5a6f;
        }
        
        .author-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .add-author-btn {
            width: 100%;
            padding: 12px;
            background: white;
            color: #667eea;
            border: 2px dashed #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .add-author-btn:hover {
            background: #f0f4ff;
            border-style: solid;
        }
        
        .date-group {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
        }
        
        .helper-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .citation-output {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .citation-label {
            font-size: 12px;
            color: #666;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .citation-text {
            font-family: 'Times New Roman', serif;
            line-height: 2;
            color: #333;
            font-size: 14px;
            word-wrap: break-word;
            text-indent: -2em;
            padding-left: 2em;
            margin-bottom: 15px;
        }
        
        .intext-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .intext-label {
            font-size: 11px;
            color: #666;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .intext-examples {
            background: white;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Times New Roman', serif;
            font-size: 13px;
            color: #555;
            line-height: 1.8;
        }
        
        .intext-example {
            margin-bottom: 6px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .copy-btn, .new-citation-btn, .save-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .copy-btn:hover, .save-btn:hover, .new-citation-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .copy-btn:active, .new-citation-btn:active, .save-btn:active {
            transform: translateY(0);
        }
        
        .success-msg {
            display: none;
            color: #4caf50;
            font-size: 12px;
            margin-top: 10px;
            font-weight: bold;
            text-align: center;
        }
        
        .history-section {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #764ba2;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .history-label {
            font-size: 12px;
            color: #666;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .clear-history-btn {
            padding: 6px 12px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .clear-history-btn:hover {
            background: #ee5a6f;
        }
        
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-family: 'Times New Roman', serif;
            font-size: 12px;
            color: #333;
            line-height: 1.6;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-item:hover {
            background: #e8f0ff;
            transform: translateX(4px);
        }
        
        .history-empty {
            text-align: center;
            color: #999;
            font-size: 13px;
            padding: 20px;
            font-style: italic;
        }
        
        .saved-section {
            margin-top: 30px;
            padding: 20px;
            background: #f0fff4;
            border-radius: 6px;
            border-left: 4px solid #4caf50;
        }
        
        .saved-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .saved-label {
            font-size: 12px;
            color: #2d5016;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .clear-saved-btn {
            padding: 6px 12px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .clear-saved-btn:hover {
            background: #ee5a6f;
        }
        
        .saved-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .saved-item {
            background: white;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 6px;
            border: 1px solid #c8e6c9;
            transition: all 0.2s;
        }
        
        .saved-item:hover {
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }
        
        .saved-citation {
            font-family: 'Times New Roman', serif;
            font-size: 13px;
            color: #333;
            line-height: 1.8;
            margin-bottom: 10px;
            text-indent: -2em;
            padding-left: 2em;
        }
        
        .saved-intext {
            background: #f9f9f9;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            color: #555;
            margin-bottom: 10px;
            font-family: 'Times New Roman', serif;
        }
        
        .saved-actions {
            display: flex;
            gap: 8px;
        }
        
        .copy-saved-btn, .delete-saved-btn {
            flex: 1;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .copy-saved-btn {
            background: #667eea;
            color: white;
        }
        
        .copy-saved-btn:hover {
            background: #5568d3;
        }
        
        .delete-saved-btn {
            background: #ff4757;
            color: white;
        }
        
        .delete-saved-btn:hover {
            background: #ee5a6f;
        }
        
        .saved-empty {
            text-align: center;
            color: #81c784;
            font-size: 13px;
            padding: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Citation Machine</h1>
        <p class="subtitle">Fill in the information below to generate your citation</p>
        
        <div class="format-toggle">
            <button class="format-btn active" onclick="setFormat('apa')">APA 7th Edition</button>
            <button class="format-btn" onclick="setFormat('mla')">MLA 9th Edition</button>
        </div>
        
        <div id="authorsContainer">
            <!-- Author sections will be added here dynamically -->
        </div>
        
        <button class="add-author-btn" onclick="addAuthor()">+ Add Another Author</button>
        
        <div class="input-group">
            <label>Publication Date</label>
            <div class="date-group">
                <input type="text" id="year" placeholder="Year (YYYY)" oninput="generateCitation()">
                <select id="month" onchange="generateCitation()">
                    <option value="">Month</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                </select>
                <input type="text" id="day" placeholder="Day" oninput="generateCitation()">
            </div>
        </div>
        
        <div class="input-group">
            <label for="title">Title of Webpage</label>
            <input type="text" id="title" placeholder="Enter the webpage title here" oninput="autoCapitalizeTitle()">
        </div>
        
        <div class="input-group">
            <label for="website">Website Name</label>
            <input type="text" id="website" placeholder="Name of the website" oninput="generateCitation()">
        </div>
        
        <div class="input-group">
            <label for="url">URL</label>
            <input type="text" id="url" placeholder="https://www.websiteurl.com" oninput="generateCitation()">
        </div>
        
        <div class="input-group" id="accessDateGroup" style="display: none;">
            <label>Access Date (MLA only)</label>
            <div class="date-group">
                <input type="text" id="accessYear" placeholder="Year (YYYY)" oninput="generateCitation()">
                <select id="accessMonth" onchange="generateCitation()">
                    <option value="">Month</option>
                    <option value="Jan.">Jan.</option>
                    <option value="Feb.">Feb.</option>
                    <option value="Mar.">Mar.</option>
                    <option value="Apr.">Apr.</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="Aug.">Aug.</option>
                    <option value="Sept.">Sept.</option>
                    <option value="Oct.">Oct.</option>
                    <option value="Nov.">Nov.</option>
                    <option value="Dec.">Dec.</option>
                </select>
                <input type="text" id="accessDay" placeholder="Day" oninput="generateCitation()">
            </div>
        </div>
        
        <div class="citation-output">
            <div class="citation-label" id="formatLabel">APA 7th Edition Citation</div>
            <div class="citation-text" id="citationText">Fill in the fields above to generate your citation</div>
            
            <div class="intext-section" id="intextSection" style="display: none;">
                <div class="intext-label">In-Text Citation Examples</div>
                <div class="intext-examples" id="intextExamples"></div>
            </div>
            
            <div class="button-group">
                <button class="copy-btn" onclick="copyCitation()">Copy</button>
                <button class="save-btn" onclick="saveCitation()">Save</button>
                <button class="new-citation-btn" onclick="newCitation()">New</button>
            </div>
            <div class="success-msg" id="successMsg">✓ Copied to clipboard!</div>
        </div>
        
        <div class="history-section" id="historySection" style="display: none;">
            <div class="history-header">
                <div class="history-label">This Session's Citations</div>
                <button class="clear-history-btn" onclick="clearHistory()">Clear All</button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>
        
        <div class="saved-section" id="savedSection" style="display: none;">
            <div class="saved-header">
                <div class="saved-label">Saved Citation Library (Persistent)</div>
                <button class="clear-saved-btn" onclick="clearSavedCitations()">Clear All</button>
            </div>
            <div class="saved-list" id="savedList"></div>
        </div>
    </div>

    <script>
        let currentFormat = 'apa';
        let authorCount = 0;
        let citationHistory = [];
        let savedCitations = [];
        
        // Load saved citations from localStorage on page load
        window.onload = function() {
            addAuthor();
            loadSavedCitations();
        };
        
        function loadSavedCitations() {
            const saved = localStorage.getItem('savedCitations');
            if (saved) {
                savedCitations = JSON.parse(saved);
                updateSavedDisplay();
            }
        }
        
        function saveCitationsToStorage() {
            localStorage.setItem('savedCitations', JSON.stringify(savedCitations));
        }
        
        // Auto Title Case Function (runs on input)
        function autoCapitalizeTitle() {
            const titleInput = document.getElementById('title');
            const cursorPosition = titleInput.selectionStart;
            const title = titleInput.value;
            
            if (!title) {
                generateCitation();
                return;
            }
            
            // Words that should NOT be capitalized (unless first or last word)
            const lowercaseWords = [
                'a', 'an', 'and', 'as', 'at', 'but', 'by', 'for', 'from', 'in', 
                'into', 'nor', 'of', 'on', 'onto', 'or', 'the', 'to', 'with', 'yet'
            ];
            
            const words = title.toLowerCase().split(' ');
            
            const titleCased = words.map((word, index) => {
                // Always capitalize first and last word
                if (index === 0 || index === words.length - 1) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
                
                // Check if word should stay lowercase
                if (lowercaseWords.includes(word)) {
                    return word;
                }
                
                // Capitalize the word
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
            
            titleInput.value = titleCased;
            titleInput.setSelectionRange(cursorPosition, cursorPosition);
            generateCitation();
        }
        
        function addAuthor() {
            authorCount++;
            const authorsContainer = document.getElementById('authorsContainer');
            
            const authorSection = document.createElement('div');
            authorSection.className = 'author-section';
            authorSection.id = 'author-' + authorCount;
            
            authorSection.innerHTML = `
                <div class="author-header">
                    <span class="author-number">Author ${authorCount}</span>
                    ${authorCount > 1 ? '<button class="remove-author-btn" onclick="removeAuthor(' + authorCount + ')">Remove</button>' : ''}
                </div>
                <div class="author-fields">
                    <div>
                        <input type="text" id="authorLast${authorCount}" placeholder="Last Name" oninput="generateCitation()">
                    </div>
                    <div>
                        <input type="text" id="authorFirst${authorCount}" placeholder="First Name" oninput="generateCitation()">
                    </div>
                </div>
            `;
            
            authorsContainer.appendChild(authorSection);
            generateCitation();
        }
        
        function removeAuthor(id) {
            const authorSection = document.getElementById('author-' + id);
            if (authorSection) {
                authorSection.remove();
                renumberAuthors();
                generateCitation();
            }
        }
        
        function renumberAuthors() {
            const authorSections = document.querySelectorAll('.author-section');
            authorCount = 0;
            authorSections.forEach((section, index) => {
                authorCount++;
                section.id = 'author-' + authorCount;
                const numberSpan = section.querySelector('.author-number');
                if (numberSpan) {
                    numberSpan.textContent = 'Author ' + authorCount;
                }
                
                // Update input IDs
                const inputs = section.querySelectorAll('input');
                inputs[0].id = 'authorLast' + authorCount;
                inputs[1].id = 'authorFirst' + authorCount;
                
                // Update remove button
                const removeBtn = section.querySelector('.remove-author-btn');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', 'removeAuthor(' + authorCount + ')');
                }
            });
        }
        
        function getAuthors() {
            const authors = [];
            for (let i = 1; i <= authorCount; i++) {
                const lastInput = document.getElementById('authorLast' + i);
                const firstInput = document.getElementById('authorFirst' + i);
                
                if (lastInput && firstInput) {
                    const last = lastInput.value.trim();
                    const first = firstInput.value.trim();
                    
                    if (last) {
                        authors.push({ last, first });
                    }
                }
            }
            return authors;
        }
        
        function setFormat(format) {
            currentFormat = format;
            document.querySelectorAll('.format-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (format === 'mla') {
                document.getElementById('accessDateGroup').style.display = 'block';
                document.getElementById('formatLabel').textContent = 'MLA 9th Edition Citation';
            } else {
                document.getElementById('accessDateGroup').style.display = 'none';
                document.getElementById('formatLabel').textContent = 'APA 7th Edition Citation';
            }
            
            generateCitation();
        }
        
        function generateCitation() {
            const authors = getAuthors();
            const year = document.getElementById('year').value.trim();
            const month = document.getElementById('month').value;
            const day = document.getElementById('day').value.trim();
            const title = document.getElementById('title').value.trim();
            const website = document.getElementById('website').value.trim();
            const url = document.getElementById('url').value.trim();
            
            if (!title) {
                document.getElementById('citationText').textContent = 'Fill in the fields above to generate your citation';
                document.getElementById('intextSection').style.display = 'none';
                return;
            }
            
            let citation = '';
            let intextCitations = [];
            
            if (currentFormat === 'apa') {
                citation = generateAPA(authors, year, month, day, title, website, url);
                intextCitations = generateAPAIntext(authors, year);
            } else {
                const accessYear = document.getElementById('accessYear').value.trim();
                const accessMonth = document.getElementById('accessMonth').value;
                const accessDay = document.getElementById('accessDay').value.trim();
                citation = generateMLA(authors, year, month, day, title, website, url, accessYear, accessMonth, accessDay);
                intextCitations = generateMLAIntext(authors);
            }
            
            document.getElementById('citationText').textContent = citation;
            
            // Show in-text citations
            if (intextCitations.length > 0) {
                document.getElementById('intextSection').style.display = 'block';
                const intextHTML = intextCitations.map(cite => 
                    `<div class="intext-example">${cite}</div>`
                ).join('');
                document.getElementById('intextExamples').innerHTML = intextHTML;
            } else {
                document.getElementById('intextSection').style.display = 'none';
            }
        }
        
        function generateAPA(authors, year, month, day, title, website, url) {
            let citation = '';
            
            // Authors
            if (authors.length > 0) {
                if (authors.length === 1) {
                    citation += authors[0].last;
                    if (authors[0].first) {
                        citation += ', ' + authors[0].first.charAt(0) + '.';
                    }
                } else if (authors.length === 2) {
                    citation += authors[0].last;
                    if (authors[0].first) {
                        citation += ', ' + authors[0].first.charAt(0) + '.';
                    }
                    citation += ', & ' + authors[1].last;
                    if (authors[1].first) {
                        citation += ', ' + authors[1].first.charAt(0) + '.';
                    }
                } else if (authors.length <= 20) {
                    for (let i = 0; i < authors.length; i++) {
                        if (i > 0) citation += ', ';
                        if (i === authors.length - 1) citation += '& ';
                        citation += authors[i].last;
                        if (authors[i].first) {
                            citation += ', ' + authors[i].first.charAt(0) + '.';
                        }
                    }
                } else {
                    // More than 20 authors
                    for (let i = 0; i < 19; i++) {
                        if (i > 0) citation += ', ';
                        citation += authors[i].last;
                        if (authors[i].first) {
                            citation += ', ' + authors[i].first.charAt(0) + '.';
                        }
                    }
                    citation += ', . . . ' + authors[authors.length - 1].last;
                    if (authors[authors.length - 1].first) {
                        citation += ', ' + authors[authors.length - 1].first.charAt(0) + '.';
                    }
                }
                citation += ' ';
            }
            
            // Date
            citation += '(';
            if (year) {
                citation += year;
                if (month) {
                    citation += ', ' + month;
                    if (day) {
                        citation += ' ' + day;
                    }
                }
            } else {
                citation += 'n.d.';
            }
            citation += '). ';
            
            // Title
            citation += title + '. ';
            
            // Website name
            if (website && (!authors.length || website !== authors[0].last)) {
                citation += website + '. ';
            }
            
            // URL
            if (url) {
                citation += url;
            }
            
            return citation;
        }
        
        function generateMLA(authors, year, month, day, title, website, url, accessYear, accessMonth, accessDay) {
            let citation = '';
            
            // Authors
            if (authors.length > 0) {
                if (authors.length === 1) {
                    citation += authors[0].last;
                    if (authors[0].first) {
                        citation += ', ' + authors[0].first;
                    }
                } else if (authors.length === 2) {
                    citation += authors[0].last;
                    if (authors[0].first) {
                        citation += ', ' + authors[0].first;
                    }
                    citation += ', and ' + authors[1].first + ' ' + authors[1].last;
                } else {
                    citation += authors[0].last;
                    if (authors[0].first) {
                        citation += ', ' + authors[0].first;
                    }
                    citation += ', et al';
                }
                citation += '. ';
            }
            
            // Title (in quotes)
            citation += '"' + title + '." ';
            
            // Website name (italicized)
            if (website) {
                citation += website + ', ';
            }
            
            // Date
            if (day && month && year) {
                citation += day + ' ' + month + ' ' + year + ', ';
            } else if (month && year) {
                citation += month + ' ' + year + ', ';
            } else if (year) {
                citation += year + ', ';
            }
            
            // URL
            if (url) {
                citation += url + '. ';
            }
            
            // Access date
            if (accessDay && accessMonth && accessYear) {
                citation += 'Accessed ' + accessDay + ' ' + accessMonth + ' ' + accessYear + '.';
            }
            
            return citation;
        }
        
        function generateAPAIntext(authors, year) {
            if (authors.length === 0) return [];
            
            const yearText = year || 'n.d.';
            let narrativeForm = '';
            let parentheticalForm = '';
            
            if (authors.length === 1) {
                narrativeForm = `${authors[0].last} (${yearText})`;
                parentheticalForm = `(${authors[0].last}, ${yearText})`;
            } else if (authors.length === 2) {
                narrativeForm = `${authors[0].last} and ${authors[1].last} (${yearText})`;
                parentheticalForm = `(${authors[0].last} & ${authors[1].last}, ${yearText})`;
            } else {
                narrativeForm = `${authors[0].last} et al. (${yearText})`;
                parentheticalForm = `(${authors[0].last} et al., ${yearText})`;
            }
            
            return [
                `Narrative: ${narrativeForm}`,
                `Parenthetical: ${parentheticalForm}`
            ];
        }
        
        function generateMLAIntext(authors) {
            if (authors.length === 0) return [];
            
            let citation = '';
            
            if (authors.length === 1) {
                citation = `(${authors[0].last})`;
            } else if (authors.length === 2) {
                citation = `(${authors[0].last} and ${authors[1].last})`;
            } else {
                citation = `(${authors[0].last} et al.)`;
            }
            
            return [
                `Basic: ${citation}`,
                `With page: ${citation.slice(0, -1)} 23)` // Example with page number
            ];
        }
        
        function copyCitation() {
            const citationText = document.getElementById('citationText').textContent;
            navigator.clipboard.writeText(citationText).then(() => {
                showSuccessMessage('✓ Copied to clipboard!');
            });
        }
        
        function showSuccessMessage(message) {
            const successMsg = document.getElementById('successMsg');
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 2000);
        }
        
        function saveCitation() {
            const citationText = document.getElementById('citationText').textContent;
            
            if (!citationText || citationText === 'Fill in the fields above to generate your citation') {
                alert('Please generate a citation first!');
                return;
            }
            
            // Get in-text citation if available
            const intextExamples = document.getElementById('intextExamples').innerHTML;
            
            // Get the first author's last name for sorting
            const authors = getAuthors();
            const sortKey = authors.length > 0 ? authors[0].last.toLowerCase() : citationText.toLowerCase();
            
            // Create citation object
            const citationObj = {
                citation: citationText,
                intext: intextExamples,
                format: currentFormat,
                sortKey: sortKey,
                timestamp: Date.now()
            };
            
            // Add to saved citations
            savedCitations.push(citationObj);
            
            // Sort alphabetically by sortKey
            savedCitations.sort((a, b) => a.sortKey.localeCompare(b.sortKey));
            
            // Save to localStorage
            saveCitationsToStorage();
            
            // Update display
            updateSavedDisplay();
            
            // Show success message
            showSuccessMessage('✓ Citation saved to library!');
            
            // Clear the form
            newCitation();
        }
        
        function updateSavedDisplay() {
            const savedSection = document.getElementById('savedSection');
            const savedList = document.getElementById('savedList');
            
            if (savedCitations.length === 0) {
                savedSection.style.display = 'none';
                return;
            }
            
            savedSection.style.display = 'block';
            savedList.innerHTML = savedCitations.map((item, index) => `
                <div class="saved-item">
                    <div class="saved-citation">${item.citation}</div>
                    ${item.intext ? '<div class="saved-intext">' + item.intext + '</div>' : ''}
                    <div class="saved-actions">
                        <button class="copy-saved-btn" onclick="copySavedCitation(${index})">Copy</button>
                        <button class="delete-saved-btn" onclick="deleteSavedCitation(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function copySavedCitation(index) {
            const citation = savedCitations[index].citation;
            navigator.clipboard.writeText(citation).then(() => {
                showSuccessMessage('✓ Copied from library!');
            });
        }
        
        function deleteSavedCitation(index) {
            if (confirm('Delete this citation from your library?')) {
                savedCitations.splice(index, 1);
                saveCitationsToStorage();
                updateSavedDisplay();
            }
        }
        
        function clearSavedCitations() {
            if (confirm('Clear all saved citations? This cannot be undone.')) {
                savedCitations = [];
                saveCitationsToStorage();
                updateSavedDisplay();
            }
        }
        
        function newCitation() {
            // Save current citation to session history before clearing
            const currentCitation = document.getElementById('citationText').textContent;
            if (currentCitation && currentCitation !== 'Fill in the fields above to generate your citation') {
                saveCitationToHistory(currentCitation);
            }
            
            // Clear all author fields
            for (let i = 1; i <= authorCount; i++) {
                const lastInput = document.getElementById('authorLast' + i);
                const firstInput = document.getElementById('authorFirst' + i);
                if (lastInput) lastInput.value = '';
                if (firstInput) firstInput.value = '';
            }
            
            // Clear all other fields
            document.getElementById('year').value = '';
            document.getElementById('month').value = '';
            document.getElementById('day').value = '';
            document.getElementById('title').value = '';
            document.getElementById('website').value = '';
            document.getElementById('url').value = '';
            document.getElementById('accessYear').value = '';
            document.getElementById('accessMonth').value = '';
            document.getElementById('accessDay').value = '';
            
            // Reset to single author
            const authorsContainer = document.getElementById('authorsContainer');
            authorsContainer.innerHTML = '';
            authorCount = 0;
            addAuthor();
            
            generateCitation();
        }
        
        function saveCitationToHistory(citation) {
            citationHistory.unshift(citation);
            updateHistoryDisplay();
        }
        
        function updateHistoryDisplay() {
            const historySection = document.getElementById('historySection');
            const historyList = document.getElementById('historyList');
            
            if (citationHistory.length === 0) {
                historySection.style.display = 'none';
                return;
            }
            
            historySection.style.display = 'block';
            historyList.innerHTML = citationHistory.map((citation, index) => 
                `<div class="history-item" onclick="copyCitationFromHistory(${index})">${citation}</div>`
            ).join('');
        }
        
        function copyCitationFromHistory(index) {
            const citation = citationHistory[index];
            navigator.clipboard.writeText(citation).then(() => {
                showSuccessMessage('✓ Copied from session history!');
            });
        }
        
        function clearHistory() {
            if (confirm('Clear all citations from this session?')) {
                citationHistory = [];
                updateHistoryDisplay();
            }
        }
    </script>
</body>
</html>
